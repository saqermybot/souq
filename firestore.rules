rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // ✅ Admin (مالك الموقع) by email
    function emailLower() {
      return request.auth.token.email != null
        ? request.auth.token.email.toLowerCase()
        : "";
    }

    function isAdmin() {
      return signedIn() && emailLower() == "alhossiniabdulhalim2@gmail.com";
    }

    // ============================================================
    // ✅ PATCH FOR Favorites + Views (drop-in blocks)
    //
    // New collections:
    // 1) listingStats/{listingId}  -> { favCount, viewsCount }
    // 2) views/{listingId_fingerprint} -> marker to count a view once
    // 3) users/{uid}/favorites/{listingId} -> per-user favorites
    //
    // Add/merge these blocks into your existing rules.
    // ============================================================

    // -------------------------
    // listingStats
    // -------------------------
    match /listingStats/{listingId} {
      allow read: if true;
      // allow create/update by anyone (including guests) BUT ONLY these two fields.
      // (We intentionally avoid strict type checks here because FieldValue.increment()
      // can be represented as a transform in the request.)
      allow create, update: if request.resource.data.keys().hasOnly(["favCount", "viewsCount"]);
      allow delete: if false;
    }

    // -------------------------
    // views markers
    // -------------------------
    match /views/{id} {
      allow read: if false; // not needed publicly
      // Anyone can create a marker once. No updates/deletes.
      allow create: if
        request.resource.data.keys().hasOnly(["listingId", "fp", "createdAt"]) ;
      allow update, delete: if false;
    }

    // -------------------------
    // user favorites subcollection
    // -------------------------
    match /users/{uid}/favorites/{listingId} {
      allow read: if signedIn() && request.auth.uid == uid;
      allow create, delete: if signedIn() && request.auth.uid == uid;
      allow update: if false;
    }

    // NOTE:
    // Keep your existing matches below (listings, users profile, chat, reports, ...)

    // -------------------------
    // reports (listing reports / wrong whatsapp / ...)
    // -------------------------
    match /reports/{id} {
      allow create: if signedIn() || isGuestCreate();
      allow read, update, delete: if isAdmin();
    }
  }
}
