rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    // âœ… Admin by email (change if needed)
    function emailLower() {
      return signedIn() && request.auth.token.email != null
        ? request.auth.token.email.toLowerCase()
        : "";
    }
    function isAdmin() {
      return signedIn() && emailLower() == "alhossiniabdulhalim2@gmail.com";
    }

    // =========================
    // Listings
    // =========================
    match /listings/{listingId} {
      allow read: if true;

      // Create requires any authenticated user (anonymous allowed)
      allow create: if signedIn()
        && request.resource.data.keys().hasAll([
          "title","description","price","currency","city","categoryId","category",
          "images","contact","sellerName","sellerEmail",
          "uid","ownerType","ownerId","guestId",
          "isActive","createdAt","expiresAt"
        ])
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.ownerId == request.auth.uid;

      // Owner can update/delete; admin can update/delete
      allow update, delete: if isAdmin()
        || (signedIn() && (
             resource.data.ownerId == request.auth.uid
             || resource.data.uid == request.auth.uid
           ));
    }

    // =========================
    // Categories (for filters)
    // =========================
    match /categories/{id} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // =========================
    // Users public profiles
    // =========================
    match /users/{uid} {
      allow read: if true;
      allow create, update: if signedIn() && request.auth.uid == uid;
      allow delete: if isAdmin();
    }

    // user favorites
    match /users/{uid}/favorites/{listingId} {
      allow read, create, delete: if signedIn() && request.auth.uid == uid;
      allow update: if false;
    }

    // =========================
    // Listing stats + views markers
    // =========================
    match /listingStats/{listingId} {
      allow read: if true;
      // Only allow increments via transaction from signed-in users
      allow create, update: if signedIn();
      allow delete: if isAdmin();
    }

    match /views/{id} {
      allow read: if false;
      allow create: if request.resource.data.keys().hasOnly(["listingId","fp","createdAt"]);
      allow update, delete: if false;
    }

    // =========================
    // Chat rooms + messages
    // Structure:
    // chats/{roomId} { participants:[uid1,uid2], listingId,... }
    // chats/{roomId}/messages/{mid} { from, text, createdAt, ... }
    // =========================
    match /chats/{roomId} {
      allow read: if signedIn() && request.auth.uid in resource.data.participants;
      allow create: if signedIn()
        && request.resource.data.participants is list
        && request.auth.uid in request.resource.data.participants;
      allow update: if signedIn() && request.auth.uid in resource.data.participants;

      allow delete: if isAdmin();

      match /messages/{mid} {
        allow read: if signedIn()
          && exists(/databases/$(database)/documents/chats/$(roomId))
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(roomId)).data.participants;

        allow create: if signedIn()
          && request.resource.data.senderId == request.auth.uid
          && exists(/databases/$(database)/documents/chats/$(roomId))
          && request.auth.uid in get(/databases/$(database)/documents/chats/$(roomId)).data.participants;

        allow update, delete: if isAdmin();
      }
    }

    // =========================
    // Reports (admins only read)
    // =========================
    match /reports/{id} {
      allow create: if signedIn(); // anonymous allowed
      allow read, update, delete: if isAdmin();
    }
  }
}
